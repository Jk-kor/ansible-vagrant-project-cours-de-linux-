---
- name: 3. Configure DNS (Bind9) on Infra Server
  hosts: infra_servers
  become: yes
  
  tasks:
    # --- Configuration des zones DNS (simplifiée via le fichier hosts pour la commodité) ---
    # En production, il faudrait modifier les fichiers de configuration Bind9 (named.conf),
    # mais ici, dans l'environnement Vagrant, on modifie le fichier hosts du serveur Infra pour une résolution simple.

    - name: Ensure hosts file contains all node IPs for simple lookup
      lineinfile:
        path: /etc/hosts
        regexp: '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\s+admin'
        line: "192.168.56.10\tadmin"
        state: present
        
    - name: Add Web node to hosts file
      lineinfile:
        path: /etc/hosts
        regexp: '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\s+web'
        line: "192.168.56.20\tweb"
        state: present

    - name: Add Infra node to hosts file
      lineinfile:
        path: /etc/hosts
        regexp: '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\s+infra'
        line: "192.168.56.30\tinfra"
        state: present

    - name: Restart Bind9 service (to load hosts file change if Bind9 is configured to use it)
      systemd:
        name: bind9
        state: restarted
  ignore_errors: yes # Ignorer les erreurs de redémarrage pour éviter de complexifier la configuration de Bind9

- name: 4. Configure Web Server to use Infra as DNS resolver
  hosts: web_servers
  become: yes
  
  tasks:
    # Configurer le serveur Web pour utiliser le serveur Infra (192.168.56.30) comme DNS via /etc/resolv.conf
    # (Ubuntu 22.04 utilise netplan, mais pour un test simple on écrase directement resolv.conf.)
    - name: Configure DNS resolver on Web
      copy:
        content: |
          nameserver 192.168.56.30
          nameserver 8.8.8.8
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: '0644'
