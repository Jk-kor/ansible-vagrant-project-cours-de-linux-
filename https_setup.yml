---
- name: Configure HTTPS on Web Server
  hosts: web_servers
  become: yes

  tasks:
    # 1. (옵션) 컨테이너 이름으로 강제 삭제 (마운트 충돌/이름 충돌 방지)
    - name: Force stop and remove nginx_proxy container (optional)
      shell: |
        docker stop nginx_proxy || true
        docker rm nginx_proxy || true
      ignore_errors: yes

    # 2. 인증서 저장 폴더 생성
    - name: Create directory for certificates
      file:
        path: /home/vagrant/app/certs
        state: directory
        owner: vagrant
        group: vagrant

    # 3. index.html은 소스(app)에서 관리: 강제 생성/덮어쓰기는 생략

    # 4. SSL 인증서 및 키 생성 (Self-Signed)
    - name: Generate Self-Signed SSL Certificate
      command: >
        openssl req -x509 -nodes -days 365 -newkey rsa:2048
        -keyout /home/vagrant/app/certs/server.key
        -out /home/vagrant/app/certs/server.crt
        -subj "/C=FR/ST=Nouvelle-Aquitaine/L=Bordeaux/O=FilRouge/CN=web"
      args:
        creates: /home/vagrant/app/certs/server.crt

    # 5. Nginx 설정 파일 생성 (HTTPS 설정 포함)
    - name: Create Nginx configuration file (default.conf)
      copy:
        dest: /home/vagrant/app/default.conf
        content: |
          server {
              listen 80;
              server_name localhost;
              # HTTP로 접속하면 HTTPS로 리다이렉트
              return 301 https://$host$request_uri;
          }

          server {
              listen 443 ssl;
              server_name localhost;

              ssl_certificate /etc/nginx/certs/server.crt;
              ssl_certificate_key /etc/nginx/certs/server.key;

              location / {
                  root /usr/share/nginx/html;
                  index index.html;
              }
          }

    # 6. docker-compose.yml은 소스(app)에서 관리: 이 플레이북에서 수정하지 않음

    # 7. 재기동은 최종 배포(final_deployment.yml)에서 일원화
